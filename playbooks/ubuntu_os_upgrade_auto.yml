---
- name: Ubuntu OS Upgrade – Version Aware & Policy Compliant
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  tasks:
    ####################################################################
    # SAFETY CHECK
    ####################################################################
    - name: Ensure system is Ubuntu
      fail:
        msg: "This playbook supports Ubuntu only."
      when: ansible_distribution != "Ubuntu"

    - name: Display current OS version
      debug:
        msg: "Current OS version: {{ ansible_distribution_version }}"

    ####################################################################
    # ENABLE LTS UPGRADES
    ####################################################################
    - name: Ensure LTS upgrades are enabled
      lineinfile:
        path: /etc/update-manager/release-upgrades
        regexp: '^Prompt='
        line: 'Prompt=lts'

    ####################################################################
    # PRE-UPGRADE: FULL UPDATE (REQUIRED BY UBUNTU)
    ####################################################################
    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_distribution_version in ["18.04", "20.04", "22.04"]

    - name: Fully upgrade current OS packages
      apt:
        upgrade: full
        dpkg_options: "force-confdef,force-confold"
      when: ansible_distribution_version in ["18.04", "20.04", "22.04"]

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot after package upgrade (if required)
      reboot:
        reboot_timeout: 1800
      when: reboot_required.stat.exists

    - name: Refresh facts after pre-upgrade
      setup:

    ####################################################################
    # 18.04 → 20.04
    ####################################################################
    - name: Upgrade Ubuntu 18.04 → 20.04
      command: do-release-upgrade -f DistUpgradeViewNonInteractive
      async: 14400
      poll: 30
      when: ansible_distribution_version == "18.04"

    - name: Reboot after 20.04 upgrade
      reboot:
        reboot_timeout: 1800
      when: ansible_distribution_version == "18.04"

    - name: Refresh facts
      setup:

    ####################################################################
    # 20.04 → 22.04
    ####################################################################
    - name: Upgrade Ubuntu 20.04 → 22.04
      command: do-release-upgrade -f DistUpgradeViewNonInteractive
      async: 14400
      poll: 30
      when: ansible_distribution_version == "20.04"

    - name: Reboot after 22.04 upgrade
      reboot:
        reboot_timeout: 1800
      when: ansible_distribution_version == "20.04"

    - name: Refresh facts
      setup:

    ####################################################################
    # 22.04 → 24.04
    ####################################################################
    - name: Upgrade Ubuntu 22.04 → 24.04
      command: do-release-upgrade -f DistUpgradeViewNonInteractive
      async: 14400
      poll: 30
      when: ansible_distribution_version == "22.04"

    - name: Final reboot after 24.04 upgrade
      reboot:
        reboot_timeout: 1800
      when: ansible_distribution_version == "22.04"

    ####################################################################
    # FINAL VERIFICATION
    ####################################################################
    - name: Refresh facts after final reboot
      setup:

    - name: Display final OS version
      debug:
        msg: "Final OS version: {{ ansible_distribution_version }}"

