---
- name: Ubuntu 20.04 → 22.04 → 24.04 upgrade (AWX-safe)
  hosts: all
  become: true
  gather_facts: false
  serial: 1

  tasks:
    - name: Stop unattended upgrades
      shell: systemctl stop unattended-upgrades || true

    - name: Disable third-party repositories
      shell: |
        mkdir -p /root/apt-backup
        mv /etc/apt/sources.list.d/* /root/apt-backup/ 2>/dev/null || true

    - name: Update apt cache
      shell: apt update

    - name: Fix broken packages
      shell: apt --fix-broken install -y

    - name: Remove held packages
      shell: |
        apt-mark showhold | xargs -r apt-mark unhold

    - name: Full dist-upgrade (MANDATORY)
      shell: apt full-upgrade -y

    - name: Check if reboot is required
      shell: |
        if [ -f /var/run/reboot-required ]; then echo reboot; fi
      register: reboot_check
      changed_when: false

    - name: Reboot before release upgrade
      reboot:
        reboot_timeout: 1800
      when: "'reboot' in reboot_check.stdout"

    - name: Verify release upgrade availability
      shell: do-release-upgrade -c
      register: release_check
      changed_when: false

    - name: Fail if Ubuntu still blocks upgrade
      fail:
        msg: |
          Ubuntu is blocking the release upgrade.
          Output:
          {{ release_check.stdout }}
      when: "'available' not in release_check.stdout"

    - name: Run release upgrade 20.04 → 22.04
      shell: do-release-upgrade -f DistUpgradeViewNonInteractive
      async: 14400
      poll: 30

