---
- name: Ubuntu Post-Upgrade Validation
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    report_dir: /var/log/awx-upgrade

  tasks:
    - name: Capture OS version
      command: lsb_release -a
      register: os
      changed_when: false

    - name: Capture kernel version
      command: uname -r
      register: kernel
      changed_when: false

    - name: Check failed services
      command: systemctl --failed
      register: failed_services
      changed_when: false

    - name: Save validation report
      copy:
        dest: "{{ report_dir }}/post_upgrade_validation.txt"
        content: |
          === OS VERSION ===
          {{ os.stdout }}

          === KERNEL ===
          {{ kernel.stdout }}

          === FAILED SERVICES ===
          {{ failed_services.stdout | default('None') }}

    - name: Fail if services are down
      fail:
        msg: "Post-upgrade validation failed. Check failed services."
      when: "'failed' in failed_services.stdout"

